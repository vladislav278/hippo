{% extends 'base.html' %}
{% load static %}

{% block title %}Личный кабинет - {{ block.super }}{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Приветственный блок -->
    <div class="welcome-card card shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 mb-2">
                        <i class="bi bi-person-circle text-primary"></i>
                        Добро пожаловать, {{ user.get_full_name }}!
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-hospital"></i> {{ user.hospital.name|default:"Больница не указана" }}
                        {% if user.specialty %}
                            <span class="ms-3">
                                <i class="bi bi-stethoscope"></i> {{ user.specialty }}
                            </span>
                        {% endif %}
                        <span class="ms-3">
                            <i class="bi bi-person-badge"></i> {{ user.get_role_display }}
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    {% if total_unread > 0 %}
                        <div class="badge bg-danger rounded-pill fs-6 px-3 py-2">
                            <i class="bi bi-envelope"></i> {{ total_unread }} новых сообщений
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Инструменты -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-tools"></i> Инструменты
            </h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                {% if user.role in 'superadmin hospital_admin doctor' %}
                    <form method="post" action="{% url 'accounts:delete_my_cases' %}" onsubmit="return confirm('Удалить все ваши консилиумы?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash3"></i> Удалить мои консилиумы
                        </button>
                    </form>
                {% endif %}
                {% if user.role == 'hospital_admin' %}
                    <form method="post" action="{% url 'accounts:delete_hospital_cases' %}" onsubmit="return confirm('Удалить все консилиумы врачей вашей больницы?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-building-x"></i> Удалить консилиумы больницы
                        </button>
                    </form>
                {% endif %}
                {% if user.role == 'superadmin' %}
                    <form method="post" action="{% url 'accounts:delete_all_cases' %}" onsubmit="return confirm('Удалить ВСЕ консилиумы? Действие необратимо.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Удалить все консилиумы
                        </button>
                    </form>
                    <form method="post" action="{% url 'accounts:delete_all_patients' %}" onsubmit="return confirm('Удалить всех пациентов? Действие необратимо.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-person-x"></i> Удалить всех пациентов
                        </button>
                    </form>
                    <form method="post" action="{% url 'accounts:delete_all_doctors_except_admin' %}" onsubmit="return confirm('Удалить всех врачей кроме admin/суперпользователей?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-person-dash"></i> Удалить всех врачей (кроме admin)
                        </button>
                    </form>
                {% endif %}
                
                {% if user.role in 'superadmin hospital_admin' %}
                    <a href="{% url 'accounts:generate_patients' %}?count=5" class="btn btn-outline-primary">
                        <i class="bi bi-person-plus"></i> Сгенерировать пациентов (5)
                    </a>
                {% endif %}
                {% if user.role in 'superadmin hospital_admin' %}
                    <a href="{% url 'accounts:generate_doctors' %}" class="btn btn-outline-success">
                        <i class="bi bi-person-badge"></i> Сгенерировать врачей (10)
                    </a>
                {% endif %}
                {% if user.role == 'superadmin' %}
                    <form method="post" action="{% url 'accounts:generate_stable_cases' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-info">
                            <i class="bi bi-book"></i> Сгенерировать консилиумы (5)
                        </button>
                    </form>
                {% endif %}
                {% if user.role in 'superadmin hospital_admin' %}
                    <a href="{% url 'accounts:registration_keys' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-key"></i> Регистрационные ключи
                    </a>
                {% endif %}
                
                {% if user.role == 'doctor' %}
                    <form method="post" action="{% url 'accounts:clear_my_patients' %}" onsubmit="return confirm('Убрать всех пациентов у текущего врача?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-warning">
                            <i class="bi bi-eraser"></i> Очистить всех моих пациентов
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100 border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="bi bi-people fs-1 text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0">{{ total_patients }}</h3>
                            <p class="text-muted mb-0">Пациентов</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100 border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="bi bi-chat-dots fs-1 text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0">{{ total_cases }}</h3>
                            <p class="text-muted mb-0">Консилиумов</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100 border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0">{{ active_cases }}</h3>
                            <p class="text-muted mb-0">Активных</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Блок консилиумов -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-chat-dots"></i> Консилиумы
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <a href="{% url 'accounts:create_case' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-circle"></i> Создать консилиум
                </a>
                <a href="{% url 'accounts:cases' %}" class="text-white text-decoration-none">
                    Все консилиумы <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if recent_cases %}
                <div class="row">
                    {% for case_data in recent_cases %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 case-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">
                                                <a href="{% url 'accounts:case_detail' case_data.case.id %}" class="text-decoration-none">{{ case_data.case.patient.full_name }}</a>
                                            </h6>
                                            <p class="text-muted small mb-1">
                                                <i class="bi bi-calendar3"></i> {{ case_data.case.admission_date|date:"d.m.Y" }}
                                            </p>
                                        </div>
                                        <div>
                                            {% if case_data.case.status == 'urgent' %}
                                                <span class="badge bg-danger">Срочно</span>
                                            {% elif case_data.case.status == 'monitoring' %}
                                                <span class="badge bg-warning">Наблюдение</span>
                                            {% else %}
                                                <span class="badge bg-success">Стабильный</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="card-text small mb-2">
                                        <strong>Диагноз:</strong> {{ case_data.case.diagnosis|truncatewords:10 }}
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            {% for doctor in case_data.case.doctors.all|slice:":3" %}
                                                <div class="avatar-circle me-1" title="{{ doctor.email }}">
                                                    {{ doctor.get_initials }}
                                                </div>
                                            {% endfor %}
                                            {% if case_data.case.doctors.count > 3 %}
                                                <span class="text-muted small ms-1">+{{ case_data.case.doctors.count|add:"-3" }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center gap-1">
                                            <a href="{% url 'accounts:manage_patient_doctors' case_data.case.patient.id %}" class="btn btn-sm btn-outline-info" title="Управление врачами пациента">
                                                <i class="bi bi-people"></i>
                                            </a>
                                            {% if case_data.unread_count > 0 %}
                                                <span class="badge bg-danger rounded-pill">{{ case_data.unread_count }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox"></i> Нет консилиумов
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Лента действий (последние консилиумы) -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Последние действия
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_cases %}
                        <div class="list-group list-group-flush">
                            {% for case_data in recent_cases %}
                                <div class="list-group-item border-0 px-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <a href="{% url 'accounts:case_detail' case_data.case.id %}" class="text-decoration-none">
                                                    {{ case_data.case.patient.full_name }}
                                                </a>
                                            </h6>
                                            <p class="text-muted small mb-1">{{ case_data.case.diagnosis|truncatewords:8 }}</p>
                                            <small class="text-muted">
                                                <i class="bi bi-calendar3"></i> {{ case_data.case.admission_date|date:"d.m.Y" }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            {% if case_data.case.status == 'urgent' %}
                                                <span class="badge bg-danger">Срочно</span>
                                            {% elif case_data.case.status == 'monitoring' %}
                                                <span class="badge bg-warning">Наблюдение</span>
                                            {% else %}
                                                <span class="badge bg-success">Стабильный</span>
                                            {% endif %}
                                            {% if case_data.unread_count > 0 %}
                                                <span class="badge bg-danger rounded-pill mt-1 d-block">{{ case_data.unread_count }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">Нет последних действий</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people"></i> Все пациенты
                        <span class="badge bg-primary ms-2">{{ all_patients|length }}</span>
                    </h5>
                    {% if user.role == 'doctor' %}
                        <a href="{% url 'accounts:my_patients' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-list-check"></i> Мои пациенты
                        </a>
                    {% endif %}
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if all_patients %}
                        <div class="list-group list-group-flush">
                            {% for patient in all_patients %}
                                <div class="list-group-item border-0 px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ patient.full_name }}</h6>
                                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                                {% if patient.date_of_birth %}
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar3"></i> {{ patient.date_of_birth|date:"d.m.Y" }}
                                                    </small>
                                                {% endif %}
                                                {% if patient.hospital %}
                                                    <small class="text-muted">
                                                        <i class="bi bi-hospital"></i> {{ patient.hospital.name }}
                                                    </small>
                                                {% endif %}
                                                {% if patient.phone %}
                                                    <small class="text-muted">
                                                        <i class="bi bi-telephone"></i> {{ patient.phone }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="d-flex gap-1 ms-2">
                                            <a href="{% url 'accounts:manage_patient_doctors' patient.id %}" class="btn btn-sm btn-outline-info" title="Управление врачами">
                                                <i class="bi bi-people"></i>
                                            </a>
                                            <a href="{% url 'admin:patients_patient_change' patient.id %}" class="btn btn-sm btn-outline-primary" title="Просмотр">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% if not forloop.last %}
                                    <hr class="my-1">
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-inbox"></i> Нет пациентов
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.welcome-card .card-body {
    color: white;
}

.welcome-card h1 {
    color: white;
}

.welcome-card .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.case-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #e0e0e0;
}

.case-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.avatar-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.875rem;
}
</style>
{% endblock %}
